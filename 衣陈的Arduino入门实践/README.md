本项目是笔者对大一上微电子学科前沿导论课设的归档。

# OverView

本项目是基于Arduino框架开发，使用arduino uno，esp32C3开发板进行蓝牙板间通信而实现的蓝牙密码锁宿舍开锁方案，基本功能如下：

**（1）基于OLED的密码UI界面，自锁功能。**

**（2）矩阵键盘输入密码，esp32驱动舵机开锁。**

**（3）ESP32与Uno板间蓝牙透传通信。**

本项目是笔者的嵌入式启蒙项目，应用到了矩阵扫描键盘，蓝牙透传模块等经典模组 及串口，定时器等单片机经典外设，本项目对开发历程做了较详尽的归档，阅读本项目，读者可以获得以下方面的参考札记，他们被归档在“参考手册与应用札记”文件夹内：

* GPIO：矩阵键盘扫描算法，基于缓冲队列的软件消抖算法，GPIO初识札记
* 定时，串口，中断： 寄存器和外设初识札记
* BLE蓝牙通信协议GATT学习，esp32板载蓝牙作为主机连接模块，实现透传通讯的demo
* **Arduino框架探讨，包裹软件框架和主控芯片的中断框架**

# Arduino架构探讨暨踩坑记录

> 笔者从小白期以一路踩坑的方式完成了项目，觉得有必要记录下这段项目的心路历程...

这部分在答辩ppt和**("\参考手册与应用笔记\1.软串口库，与定时中断和I2C通信冲突.md")** 中有部分归档记录，但真正有用的信息应该是IC手册 而非笔者的札记。

**省流内容如下：**

## Arduino编程框架：

首先，arduino的 setup 和loop 就是main函数中while(1)内外的两个函数，然后，关于串口中断事件，Arduino框架把底层藏得很严实呢

附：Arduino的串口中断是一种软中断，串口的RX，TX事件发生后，仅将flag位寄存器挂起，把数据留存缓冲区，在loop执行完毕后开始执行中断服务程序

(图片来源网络)

![image-20221207152238932](https://s2.loli.net/2022/12/07/WVEX9SnwfBJLQZa.png)

![image-20221209134719336](https://s2.loli.net/2022/12/09/AJxKUPE3ImsCwrb.png)

Serial串口（的RX）中断属于伪中断，在代码文件中写下的与串口事件有关的函数经编译后，整合在SerialEvent里。当且仅当同时满足==loop执行完毕，硬串口对象Serial被实例化，其RX缓冲区有数据传入==，才会执行SerialEvent

**Refercence**:[Arduino的伪中断](https://zhuanlan.zhihu.com/p/44104620)

所以为什么会影响定时中断呢：嘻嘻

## ATmega328P中断框架

**Refercence:**:[Arduino踩坑手册-《中断故障排查指南》-中断、串口、定时器等片内硬件资源之间的冲突](https://blog.csdn.net/u014554395/article/details/89152573)

**Refercence:**[Uno主控芯片手册datasheet](C:\Users\yceachan\Desktop\ICthings\Projects\uno主控芯片手册.ptf.pdf)

* 很喜欢博主的一句话：**（在过度封装而不阅读文档下，）Arduino就是个儿童玩具**

![image-20230416135612780](https://s2.loli.net/2023/04/16/OFvkr5MaldpjfTJ.png)

省流结论：

ATmega328P不支持嵌套中断，没有中断队列，所有中断仅能按datasheet中的中断服务地址顺序仲裁优先级

![image-20230416140336250](https://s2.loli.net/2023/04/16/pFhkPm5Kc76JdlU.png)

对于儿童玩具uno，中断管理不是通过寄存器配置优先级，而是**在中断函数中手写寄存器使失能所有其他中断。**

**省流总结：**

在一个中断信号生成时，唯一的中断管理寄存器I被置零，一切中断都被失能，暨，这个中断优先局全局最高，不能被任何中断打断。

软件可以在中断函数内写这个寄存器，把I寄存器置1，使能所有中断，暨，这个中断服务优先级全局最低，甚至能被自己的下一个中断信号打断？

![image-20230416140827795](https://s2.loli.net/2023/04/16/5CeiEVjJok7ScZ1.png)

Arduino软件框架封装了以下两个中断管理宏。

```
cli();  // 关闭全局中断
sei();  //开启全局中断。
```

# 项目结语：

**（在过度封装==而不阅读文档==下，）Arduino就是个儿童玩具**

但，踩到坑不翻文档不做实验只想从CSDN粪里淘金，才是真的小朋友呢。